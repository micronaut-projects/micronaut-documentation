<!DOCTYPE html>
<html lang="en"><head><style type="text/css">.truste_caIcon_display {display: block !important;}</style><style type="text/css">.truste_cursor_pointer {cursor: pointer;}.truste_border_none {border: none;}</style>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:image" content="https://graal.cloud/gdk/resources/img/graalvm.png">
    <meta name="twitter:widgets:border-color" content="#55acee">

    <link rel="stylesheet" href="https://graal.cloud/gdk/resources/lib/highlight/highlight.min.js">
    <script src="https://graal.cloud/gdk/resources/lib/highlight/highlight.min.js"></script>

    <title>Create and Deploy a Streaming Application with Amazon Managed Streaming for Apache Kafka (MSK)</title>
    <meta name="description" content="The Graal Development Kit for Micronaut (GDK) is a build of a curated set of Micronaut framework modules and their required libraries for building portable c...">
    <meta name="last_modified" content="2024-10-10 16:30:05 +0000">
    <meta name="last_built" content="2024-10-29 09:25:27 +0000">
    <link rel="stylesheet" href="https://graal.cloud/gdk/assets/main.css" >
    <link rel="apple-touch-icon" sizes="180x180" href="https://graal.cloud/gdk/resources/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://graal.cloud/gdk/resources/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://graal.cloud/gdk/resources/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="https://graal.cloud/gdk/resources/img/favicon/site.webmanifest">
    <link rel="stylesheet" type="text/css" href="https://graal.cloud/gdk/resources/styles/codicon.css" />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <meta name="google-site-verification" content="-vRqwa9WYn6AaQGnl88xvrLw6ac4xoKVkZkhanmlRhU">
    <link rel="canonical" href="https://www.graal.cloud/gdk/gdk-modules/database/micronaut-data-jdbc-repository/">

    <!-- TODO: move to stylesheet -->
    <style>
        @media (min-width: 768px) {
            .content {
                padding-top: 60px;
            }
        }

        .colist table {
            border: 0;

            td {
                border: 0;
            }

            tr {
                border: 0;
            }
        }

        .imageblock {
            max-width: 50%;
        }

        main{
            padding-top: 50px !important;
        }

        .content{
            padding-top: 0;
        }

        ul.sectlevel0 > li > a:first-of-type {
            color: #F68831 !important;
            font-weight: 700;
        }

        ul.sectlevel1 > li > a {
            color: #dbe6ff;
            font-weight: 400 !important;
            padding-left: 20px;
            font-size: 14px;
        }

            .conum[data-value]::after {
                content: attr(data-value);
                display: inline-block;
                border: 1px solid;
                -webkit-border-radius: 50%;
                border-radius: 50%;
                text-align: center;
                font-size: .75em;
                width: 1.67em;
                height: 1.67em;
                line-height: 1.67em;
                font-family: "Open Sans", "DejaVu Sans", sans-serif;
                font-style: normal;
                font-weight: bold;
            }
            .conum[data-value]+b {
                display: none;
            }

        .sectlevel1 a.active {
            color: #F68831;
            font-weight: bold;
        }
        a.external {
            color: #d6d6d6   !important;
        }
        a.external:hover {
            color: white !important;
            background-color: #1e2631 !important;
        }
    </style>

    <!-- jQuery UI Tabs -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://graal.cloud/gdk/resources/lib/jquery/jquery-ui.css">
    <script type="text/javascript" id="www-widgetapi-script" src="https://www.youtube.com/s/player/a8476471/www-widgetapi.vflset/www-widgetapi.js" async=""></script><script src="https://www.youtube.com/iframe_api"></script><script async="" src="https://tags.bkrtx.com/js/bk-coretag.js"></script><script src="https://graal.cloud/gdk/resources/lib/jquery/jquery-3.7.1.min.js"></script><script src="https://graal.cloud/gdk/resources/lib/bootstrap/js/bootstrap.min.js"></script><script src="https://graal.cloud/gdk/resources/lib/sticky-sidebar/resizeSensor.js"></script><script src="https://graal.cloud/gdk/resources/lib/sticky-sidebar/sticky-sidebar.min.js"></script><script async="" defer="" src="https://buttons.github.io/buttons.js"></script><script async="async" type="text/javascript" src="//consent.trustarc.com/notice?domain=oracle.com&amp;c=teconsent&amp;js=bb&amp;noticeType=bb&amp;text=true&amp;cdn=1&amp;pcookie&amp;gtm=1" crossorigin="" id="truste_0.9548969741402604"></script><script src="https://www.oracle.com/assets/truste-oraclelib.js"></script><script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script></head>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        const menuLinks = document.querySelectorAll(".sectlevel1 a");

        function highlightMenu() {
            let currentSection = null;

            menuLinks.forEach(link => {
                const section = document.querySelector(link.getAttribute("href"));
                if (section) {
                    const rect = section.getBoundingClientRect();
                    if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                        currentSection = link;
                    }
                }
            });

            menuLinks.forEach(link => link.classList.remove("active"));

            if (currentSection) {
                currentSection.classList.add("active");
            }
        }

        window.addEventListener("scroll", highlightMenu);
        highlightMenu();

        });</script>
<!-- Add TRUSTe Consent Script and Analytics -->


<!-- jQuery UI Tabs -->

<body class="">
<!-- Start SiteCatalyst code -->
<script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script><script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_code_otn.js"></script><script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_code.js"></script>
<!-- End SiteCatalyst code -->

<div class="wrapper wrapper--nofooter">

    <header class="header header--content" role="banner">
        <nav class="menu">
            <div class="menu__row">
                <div>
                    <a href="/gdk/" class="activeMenuItem">
                        <img class="logo-mobile" src="https://graal.cloud/gdk/resources/img/gdk-logo-new.svg" alt="Graal Development Kit for Micronaut logo" style="margin-left: 0px;">
                    </a>
                </div>
                <div class="menu__container">
                    <ul class="menu__list">
                        <li class="menu__item">
                            <a href="/gdk/about/" class="menu__link">About</a>
                        </li>
                        <li class="menu__item">
                            <a href="/gdk/get-started/" class="menu__link">Get Started</a>
                        </li>
                        <li class="menu__item">
                            <div class="stack-container">
                                <a href="#" class="menu__link stack__header">Docs</a>
                                <div class="stack-menu-learn">
                                    <div class="stack-row">
                                        <div class="stack-column">
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/modules.svg">
                                                <a href="/gdk/modules/" class="item-line">Modules</a>
                                            </div>
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/guides.svg">
                                                <a href="/gdk/guides/" class="item-line">Guides</a>
                                            </div>
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/labs.svg">
                                                <a href="/gdk/hands-on-labs/" class="item-line">Hands-On Labs</a>
                                            </div>
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/tools.svg">
                                                <a href="/gdk/vscode-tools/" class="item-line">Tools</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="menu__item">
                            <div class="stack-container">
                                <a href="#" class="menu__link stack__header">Graal Projects</a>
                                <div class="stack-menu">
                                    <div class="stack-row">
                                        <div class="stack-column">
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/graalstack.svg">
                                                <a href="/" class="item-line">Graal</a>
                                            </div>
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/graalvm.svg">
                                                <a href="https://graalvm.org/" class="item-line">GraalVM</a>
                                            </div>
                                            <div class="stack__item">
                                                <img src="https://graal.cloud/gdk/resources/img/header-navigation/graalos.svg">
                                                <a href="/graalos/" class="item-line">GraalOS</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="menu__launch__mobile">
                            <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
                        </li>
                    </ul>
                </div>
                <div class="menu__launch">
                    <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
                </div>
            </div>

            <div role="button" class="menu-btn menu-btn--menu js-show-menu" tabindex="-1" title="sweet hamburger">
                <div class="hamburger">
                    <div class="inner"></div>
                </div>
            </div>
            <button aria-label="hamburger mobile menu" class="btn btn-mobile-menu js-show-menu">
                <div class="inner"></div>
            </button>
        </nav>


    </header>


    <main class="content" aria-label="Content">
        <div class="wrapper wrapper-content">
            <article>
                <div class="row d-flex flex-wrap">
                    <div class="col-sm-3 docsimpro col-bg">
                        <div class="sidebar-wrap is-affixed" style="height: 473px; position: relative;"><div class="inner-wrapper-sticky" style="position: fixed; top: 74px; left: 0px; width: 300px;">
                            <div class="sidebar">
                                <div class="menuabout">
                                    <img id="sidebarClose" src="https://graal.cloud/gdk/resources/img/arrow_sidebar(close).svg" alt="Expand or collapse sidebar" class="btn-color no-display">
                                    <img id="sidebarOpen" src="https://graal.cloud/gdk/resources/img/arrow_sidebar.svg" alt="Expand or collapse sidebar">
                                </div>

                                                                <div class="toc-floating">
                                <div class="toc-bullets">
                                    <li class="toc-bullets-main">
                                        <a href="/gdk/docs/gdk-modules/streaming/" class="_icon-book">
                                            Streaming
                                        </a>
                                    </li>
                                    <li class="toc-bullets-sub toc-bullets-highlight">
                                        <a href="/gdk/gdk-modules/streaming/micronaut-streaming-aws/" class="activeMenuItem">
                                            Create and Deploy a Streaming Application with Amazon Managed Streaming for Apache Kafka (MSK)
                                        </a>
                                    </li>
                                    <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#create-the-books-microservice">1. Create the <em>books</em> Microservice</a></li>
<li><a href="#create-the-analytics-microservice">2. Create the <em>analytics</em> Microservice</a></li>
<li><a href="#run-the-microservices">3. Run the Microservices</a></li>
<li><a href="#set-up-aws-resources">4. Set up AWS Resources</a></li>
<li><a href="#configure-microservices">5. Configure Microservices</a></li>
<li><a href="#generate-a-native-executable-using-graalvm">6. Generate a Native Executable Using GraalVM</a></li>
<li><a href="#deploy-the-books-microservice-to-aws-cloud">7. Deploy the <em>Books</em> Microservice to AWS Cloud</a></li>
<li><a href="#deploy-the-analytics-microservice-to-aws-cloud">8. Deploy the <em>Analytics</em> Microservice to AWS Cloud</a></li>
<li><a href="#deploy-native-executables-to-aws-cloud">9. Deploy Native Executables to AWS Cloud</a></li>
</ul>
</div>
                                </div>
                            </div>


                            </div>
                            <div class="resize-sensor" style="position: absolute; inset: 0px; overflow: hidden; z-index: -1; visibility: hidden;"><div class="resize-sensor-expand" style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden;"><div style="position: absolute; left: 0px; top: 0px; transition: all 0s ease 0s; width: 100000px; height: 100000px;"></div></div><div class="resize-sensor-shrink" style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden;"><div style="position: absolute; left: 0; top: 0; transition: 0s; width: 200%; height: 200%"></div></div></div></div></div>
                        <div class="resize-sensor" style="position: absolute; inset: 0px; overflow: hidden; z-index: -1; visibility: hidden;"><div class="resize-sensor-expand" style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden;"><div style="position: absolute; left: 0px; top: 0px; transition: all 0s ease 0s; width: 100000px; height: 100000px;"></div></div><div class="resize-sensor-shrink" style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden;"><div style="position: absolute; left: 0; top: 0; transition: 0s; width: 200%; height: 200%"></div></div></div></div>

                    <div class="col-sm-9 docsmod">
                        <div id="content-wrapper" class="docs-content docs-content--with-sidebar"><h1>Create and Deploy a Streaming Application with Amazon Managed Streaming for Apache Kafka (MSK)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide describes how to use the Graal Development Kit for Micronaut (GDK) to create a streaming application that uses Micronaut® Streaming. 
The application consists of two Micronaut microservices that use Amazon MSK to communicate with each other in an asynchronous and decoupled way.</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com/msk/">Amazon Managed Streaming for Apache Kafka (MSK)</a> securely streams data with a fully managed, highly available Apache Kafka service.</p>
</div>
<div class="paragraph">
<p><strong>Prerequisites</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 17 or higher. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>.</p>
</li>
<li>
<p>An Amazon Web Services (AWS) account. See <a href="/gdk/get-started/setting-up-cloud-accounts/">Setting up Your Cloud Accounts</a>.</p>
</li>
<li>
<p>The <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI</a>.</p>
</li>
<li>
<p>An AWS user with enough permissions to create and manage the AWS MSK service.</p>
</li>
<li>
<p>A Docker-API compatible container runtime such as <a href="https://docs.rancherdesktop.io/getting-started/installation/">Rancher Desktop</a> or <a href="https://www.docker.io/gettingstarted/">Docker</a> installed.</p>
</li>
<li>
<p>The GDK CLI. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>. (Optional.)</p>
</li>
</ul>
</div>
<div id="download" class="paragraph">
<p>Follow the steps below to create the application from scratch. However, you can also download the completed example:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <a href="https://github.com/oracle/graal-dev-kit/releases/download/4.7.3.5/4.7.3.5_streaming_aws-streaming-demo-java-gradle.zip">Gradle AWS Streaming Example <img src="https://graal.cloud/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" class="download-img-guides"/></a>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <a href="https://github.com/oracle/graal-dev-kit/releases/download/4.7.3.5/4.7.3.5_streaming_aws-streaming-demo-java-maven.zip">Maven AWS Streaming Example <img src="https://graal.cloud/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" class="download-img-guides"/></a>
    </div>
</div>
<div class="paragraph">
<p>The application ZIP file will be downloaded in your default downloads directory. Unzip it and proceed to the next steps.</p>
</div>
<h4 id="a-note-regarding-your-development-environment" class="discrete">A note regarding your development environment</h4>
<div class="paragraph">
<p>Consider using Visual Studio Code, which provides native support for developing applications with the <a href="https://marketplace.visualstudio.com/items?itemName=oracle-labs-graalvm.graal-cloud-native-pack">Graal Development Kit for Micronaut Extension Pack</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: If you use IntelliJ IDEA, <a href="/gdk/resources/img/annotationprocessorsintellij.png">enable annotation processing</a>.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Windows platform: The GDK guides are compatible with Gradle only. Maven support is coming soon.</p>
</div>
</blockquote>
</div>
<h2 id="create-the-microservices" class="discrete">Create the Microservices</h2>
<div class="paragraph">
<p>The two microservices are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Books</em> returns a list of books. It uses a domain consisting of a book name and an International Standard Book Number (ISBN). It also publishes a message to the streaming service every time a book is accessed.</p>
</li>
<li>
<p><em>Analytics</em> connects to the streaming service to update the analytics for every book (a counter). It also exposes an endpoint to retrieve the counter.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-books-microservice">1. Create the <em>books</em> Microservice</h2>
<div class="sectionbody">
<p>Create an application using the GDK Launcher.</p>
<ol>
    <li>
        <p>Open the <a href="https://graal.cloud/gdk/launcher/?advanced=true" target="_blank">GDK Launcher in advanced mode</a>.</p>
    </li>
    <li>Create a new project using the following selections.
        <ul>
            <li><strong>Project Type</strong>: <em>Application</em> (Default)</li>
            <li><strong>Project Name</strong>: <em>books</em></li>
            <li><strong>Base Package</strong>: <em>com.example.publisher</em></li>
            <li><strong>Clouds</strong>: <em>AWS</em></li>
            <li><strong>Build Tool</strong>: <em>Gradle (Groovy)</em> or <em>Maven</em></li>
            <li><strong>Language</strong>: <em>Java</em> (Default)</li>
            <li><strong>Test Framework</strong>: <em>JUnit</em> (Default)</li>
            <li><strong>Java Version</strong>: <em>17</em> (Default)</li>
            <li><strong>Micronaut Version</strong>: (Default)</li>
            <li><strong>Cloud Services</strong>: <em>Streaming</em></li>
            <li><strong>Features</strong>: <em>GraalVM Native Image</em>, <em>Reactor</em>, <em>Micronaut Serialization Jackson Core</em>, <em>Awaitility Framework</em></li>
            <li><strong>Sample Code</strong>: <em>Yes</em> (Default)</li>
        </ul>
    </li>
    <li>Click <strong>Generate Project</strong>, then click <strong>Download Zip</strong>. The GDK Launcher creates an application with the package <code>com.example.publisher</code> in a directory named <em>books</em>. The application ZIP file will be downloaded to your default downloads directory. Unzip it, open it in your code editor, and proceed to the next steps.</li>
</ol>
<div class="paragraph">
<p>Alternatively, use the  <a href="/gdk/get-started/using-gdk-cli/">GDK CLI</a> as follows:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">gdk create-app com.example.publisher.books \
 --clouds=aws \
 --services=streaming \
 --features=graalvm,reactor,serialization-jackson,awaitility \
 --build=gradle \
 --jdk=17  \
 --lang=java</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">gdk create-app com.example.publisher.books \
 --clouds=aws \
 --services=streaming \
 --features=graalvm,reactor,serialization-jackson,awaitility \
 --build=maven \
 --jdk=17  \
 --lang=java</code><button>Copy</button></pre>
    </div>
</div>
<div class="paragraph">
<p>Open the <em>micronaut-cli.yml</em> file, you can see what features are packaged with the application:</p>
</div>
<pre><code class="language-bash hljs" data-highlighted="yes">features: [app-name, awaitility, aws-v2-sdk, gdk-aws-cloud-app, gdk-aws-streaming, gdk-bom, gdk-license, graalvm, http-client, java, java-application, junit, kafka, logback, maven, maven-enforcer-plugin, micronaut-http-validation, netty-server, properties, reactor, reactor-http-client, readme, serialization-jackson, shade, static-resources, test-resources]</code><button>Copy</button></pre>
<div class="sect2">
<h3 id="book-domain-class">1.1. Book Domain Class</h3>
<div class="paragraph">
<p>The GDK Launcher created a <code>Book</code> domain class in a file named <em>lib/src/main/java/com/example/publisher/Book.java</em>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.publisher;

import io.micronaut.core.annotation.Creator;
import io.micronaut.serde.annotation.Serdeable;

import java.util.Objects;

@Serdeable
public class Book {

    private final String isbn;
    private final String name;

    @Creator
    public Book(String isbn, String name) {
        this.isbn = isbn;
        this.name = name;
    }

    public String getIsbn() {
        return isbn;
    }

    public String getName() {
        return name;
    }

    @Override
    public String toString() {
        return "Book{" +
                "isbn='" + isbn + '\'' +
                ", name='" + name + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Book other = (Book) o;
        return Objects.equals(isbn, other.isbn) &amp;&amp;
                Objects.equals(name, other.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(isbn, name);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bookservice">1.2. BookService</h3>
<div class="paragraph">
<p>To keep this guide simple there is no database persistence: the <em>Books</em> microservice keeps the list of books in memory. The GDK Launcher created a class named <code>BookService</code> in <em>lib/src/main/java/com/example/publisher/BookService.java</em> with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.publisher;

import jakarta.annotation.PostConstruct;
import jakarta.inject.Singleton;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Singleton
public class BookService {

    private final List&lt;Book&gt; bookStore = new ArrayList&lt;&gt;();

    @PostConstruct
    void init() {
        bookStore.add(new Book("1491950358", "Building Microservices"));
        bookStore.add(new Book("1680502395", "Release It!"));
        bookStore.add(new Book("0321601912", "Continuous Delivery"));
    }

    public List&lt;Book&gt; listAll() {
        return bookStore;
    }

    public Optional&lt;Book&gt; findByIsbn(String isbn) {
        return bookStore.stream()
                .filter(b -&gt; b.getIsbn().equals(isbn))
                .findFirst();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bookcontroller">1.3. BookController</h3>
<div class="paragraph">
<p>The GDK Launcher created a controller to access <code>Book</code> instances in a file named <em>lib/src/main/java/com/example/publisher/BookController.java</em> with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.publisher;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;

import java.util.List;
import java.util.Optional;

@Controller("/books") <i class="conum" data-value="1"></i><b>(1)</b>
class BookController {

    private final BookService bookService;

    BookController(BookService bookService) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.bookService = bookService;
    }

    @Get <i class="conum" data-value="3"></i><b>(3)</b>
    List&lt;Book&gt; listAll() {
        return bookService.listAll();
    }

    @Get("/{isbn}") <i class="conum" data-value="4"></i><b>(4)</b>
    Optional&lt;Book&gt; findBook(String isbn) {
        return bookService.findByIsbn(isbn);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html"><code>@Controller</code></a> annotation defines the class as a controller mapped to the root URI <code>/books</code>.</p>
</div>
<div class="paragraph">
<p><strong>2</strong> Use constructor injection to inject a bean of type <code>BookService</code>.</p>
</div>
<div class="paragraph">
<p><strong>3</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>listAll</code> method to an HTTP GET request on <code>/books</code>.</p>
</div>
<div class="paragraph">
<p><strong>4</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>findBook</code> method to an HTTP GET request on <code>/books/{isbn}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="bookcontrollertest">1.4. BookControllerTest</h3>
<div class="paragraph">
<p>The GDK Launcher created a test for <code>BookController</code> to verify the interaction with the <em>Analytics</em> microservice in a file named <em>aws/src/test/java/com/example/publisher/BookControllerTest.java</em> with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.publisher;

import io.micronaut.configuration.kafka.annotation.KafkaListener;
import io.micronaut.configuration.kafka.annotation.Topic;
import io.micronaut.core.annotation.NonNull;
import io.micronaut.core.type.Argument;
import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.HttpClient;
import io.micronaut.http.client.annotation.Client;
import io.micronaut.http.client.exceptions.HttpClientResponseException;
import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;

import jakarta.inject.Inject;
import java.util.Collection;
import java.util.Optional;
import java.util.concurrent.ConcurrentLinkedDeque;

import static io.micronaut.configuration.kafka.annotation.OffsetReset.EARLIEST;
import static java.util.concurrent.TimeUnit.SECONDS;
import static org.awaitility.Awaitility.await;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.TestInstance.Lifecycle.PER_CLASS;

@MicronautTest
@TestInstance(PER_CLASS) <i class="conum" data-value="1"></i><b>(1)</b>
class BookControllerTest {

    private static final Collection&lt;Book&gt; received = new ConcurrentLinkedDeque&lt;&gt;();

    @Inject
    AnalyticsListener analyticsListener; <i class="conum" data-value="2"></i><b>(2)</b>

    @Inject
    @Client("/")
    HttpClient client; <i class="conum" data-value="3"></i><b>(3)</b>

    @Test
    void testMessageIsPublishedToKafkaWhenBookFound() {
        String isbn = "1491950358";

        Optional&lt;Book&gt; result = retrieveGet("/books/" + isbn); <i class="conum" data-value="4"></i><b>(4)</b>
        assertNotNull(result);
        assertTrue(result.isPresent());
        assertEquals(isbn, result.get().getIsbn());

        await().atMost(5, SECONDS).until(() -&gt; !received.isEmpty()); <i class="conum" data-value="5"></i><b>(5)</b>

        assertEquals(1, received.size()); <i class="conum" data-value="6"></i><b>(6)</b>
        Book bookFromKafka = received.iterator().next();
        assertNotNull(bookFromKafka);
        assertEquals(isbn, bookFromKafka.getIsbn());
    }

    @Test
    void testMessageIsNotPublishedToKafkaWhenBookNotFound() throws Exception {
        assertThrows(HttpClientResponseException.class, () -&gt; {
            retrieveGet("/books/INVALID");
        });

        Thread.sleep(5_000); <i class="conum" data-value="7"></i><b>(7)</b>
        assertEquals(0, received.size());
    }

    @AfterEach
    void cleanup() {
        received.clear();
    }

    @KafkaListener(offsetReset = EARLIEST)
    static class AnalyticsListener {

        @Topic("analytics")
        void updateAnalytics(Book book) {
            received.add(book);
        }
    }

    private Optional&lt;Book&gt; retrieveGet(String url) {
        return client.toBlocking().retrieve(HttpRequest.GET(url), Argument.of(Optional.class, Book.class));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests.</p>
</div>
<div class="paragraph">
<p><strong>2</strong> Dependency injection for the <code>AnalyticsListener</code> class declared later in the file. This is a listener class that replicates the functionality of the class of the same name in the <em>Analytics</em> microservice.</p>
</div>
<div class="paragraph">
<p><strong>3</strong> Dependency injection for an HTTP client that the Micronaut framework will implement at compile to make calls to <code>BookController</code>.</p>
</div>
<div class="paragraph">
<p><strong>4</strong> Use the <code>HttpClient</code> to retrieve the details of a <code>Book</code>, which will trigger sending a message.</p>
</div>
<div class="paragraph">
<p><strong>5</strong> Wait a few seconds for the message to arrive; it should happen very quickly, but the message will be sent on a separate thread.</p>
</div>
<div class="paragraph">
<p><strong>6</strong> Verify that the message was received and that it has the correct data.</p>
</div>
<div class="paragraph">
<p><strong>7</strong> Wait a few seconds to ensure no message is received.</p>
</div>
</div>
<div class="sect2">
<h3 id="analyticsclient">1.5. AnalyticsClient</h3>
<div class="paragraph">
<p>The GDK Launcher created a client interface to send messages to the streaming service in a file named <em>lib/src/main/java/com/example/publisher/AnalyticsClient.java</em> with the contents shown below. (Micronaut generates an implementation for the client interface at compilation time.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.publisher;

import io.micronaut.configuration.kafka.annotation.KafkaClient;
import io.micronaut.configuration.kafka.annotation.Topic;
import reactor.core.publisher.Mono;

@KafkaClient
public interface AnalyticsClient {

    @Topic("analytics") <i class="conum" data-value="1"></i><b>(1)</b>
    Mono&lt;Book&gt; updateAnalytics(Book book); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> Set the name of the topic.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: This must match the name of the topic that you will create later.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>2</strong> Send the <code>Book</code> POJO. Micronaut will automatically convert it to JSON before sending it.</p>
</div>
</div>
<div class="sect2">
<h3 id="analyticsfilter">1.6. AnalyticsFilter</h3>
<div class="paragraph">
<p>Sending a message to the streaming service is as simple as injecting <code>AnalyticsClient</code> and calling its <code>updateAnalytics</code> method.
The goal is to send a message every time the details of a book are returned from the <em>Books</em> microservice or, in other words, every time there is a call to <code>http://localhost:8080/books/{isbn}</code>.
To achieve this, the GDK Launcher created an <a href="https://docs.micronaut.io/latest/guide/#filters">Http Server Filter</a> in a file named <em>lib/src/main/java/com/example/publisher/AnalyticsFilter.java</em> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.publisher;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.MutableHttpResponse;
import io.micronaut.http.annotation.Filter;
import io.micronaut.http.filter.HttpServerFilter;
import io.micronaut.http.filter.ServerFilterChain;
import reactor.core.publisher.Flux;
import org.reactivestreams.Publisher;

@Filter("/books/?*") <i class="conum" data-value="1"></i><b>(1)</b>
class AnalyticsFilter implements HttpServerFilter { <i class="conum" data-value="2"></i><b>(2)</b>

    private final AnalyticsClient analyticsClient;

    AnalyticsFilter(AnalyticsClient analyticsClient) { <i class="conum" data-value="3"></i><b>(3)</b>
        this.analyticsClient = analyticsClient;
    }

    @Override
    public Publisher&lt;MutableHttpResponse&lt;?&gt;&gt; doFilter(HttpRequest&lt;?&gt; request,
                                                      ServerFilterChain chain) { <i class="conum" data-value="4"></i><b>(4)</b>
        return Flux
                .from(chain.proceed(request)) <i class="conum" data-value="5"></i><b>(5)</b>
                .flatMap(response -&gt; {
                    Book book = response.getBody(Book.class).orElse(null); <i class="conum" data-value="6"></i><b>(6)</b>
                    if (book == null) {
                        return Flux.just(response);
                    }
                    return Flux.from(analyticsClient.updateAnalytics(book)).map(b -&gt; response); <i class="conum" data-value="7"></i><b>(7)</b>
                });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> Annotate the class with <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Filter.html"><code>@Filter</code></a> and define the <a href="https://ant.apache.org/manual/dirtasks.html#patterns">Ant-style matcher pattern</a> to intercept all calls to the desired URIs.</p>
</div>
<div class="paragraph">
<p><strong>2</strong> The class must implement <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/filter/HttpServerFilter.html"><code>HttpServerFilter</code></a>.</p>
</div>
<div class="paragraph">
<p><strong>3</strong> Dependency injection for <code>AnalyticsClient</code>.</p>
</div>
<div class="paragraph">
<p><strong>4</strong> Implement the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/filter/HttpServerFilter.html#doFilter-io.micronaut.http.HttpRequest-io.micronaut.http.filter.FilterChain-"><code>doFilter</code></a> method.</p>
</div>
<div class="paragraph">
<p><strong>5</strong> Call the request; this will invoke the controller action.</p>
</div>
<div class="paragraph">
<p><strong>6</strong> Get the response from the controller and return the body as an instance of the <code>Book</code> class.</p>
</div>
<div class="paragraph">
<p><strong>7</strong> If the book is retrieved, use the client to send a message.</p>
</div>
</div>
<div class="sect2">
<h3 id="test-the-microservice">1.7. Test the Microservice</h3>
<div class="paragraph">
<p>Use the following command to test the microservice</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">./gradlew :aws:test</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
./mvnw package -pl aws -DskipTests
./mvnw test</code><button>Copy</button></pre>
    </div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-analytics-microservice">2. Create the <em>analytics</em> Microservice</h2>
<div class="sectionbody">
<p>Create an application using the GDK Launcher.</p>
<ol>
    <li>
        <p>Open the <a href="https://graal.cloud/gdk/launcher/?advanced=true" target="_blank">GDK Launcher in advanced mode</a>.</p>
    </li>
    <li>Create a new project using the following selections.
        <ul>
            <li><strong>Project Type</strong>: <em>Application</em> (Default)</li>
            <li><strong>Project Name</strong>: <em>analytics</em></li>
            <li><strong>Base Package</strong>: <em>com.example.consumer</em></li>
            <li><strong>Clouds</strong>: <em>AWS</em></li>
            <li><strong>Build Tool</strong>: <em>Gradle (Groovy)</em> or <em>Maven</em></li>
            <li><strong>Language</strong>: <em>Java</em> (Default)</li>
            <li><strong>Test Framework</strong>: <em>JUnit</em> (Default)</li>
            <li><strong>Java Version</strong>: <em>17</em> (Default)</li>
            <li><strong>Micronaut Version</strong>: (Default)</li>
            <li><strong>Cloud Services</strong>: <em>Streaming</em></li>
            <li><strong>Features</strong>: <em>GraalVM Native Image</em>, <em>Micronaut Serialization Jackson Core</em>, <em>Awaitility Framework</em></li>
            <li><strong>Sample Code</strong>: <em>Yes</em> (Default)</li>
        </ul>
    </li>
    <li>Click <strong>Generate Project</strong>, then click <strong>Download Zip</strong>. The GDK Launcher creates an application with the package <code>com.example.consumer</code> in a directory named <em>analytics</em>. The application ZIP file will be downloaded to your default downloads directory. Unzip it, open it in your code editor, and proceed to the next steps.</li>
</ol>
<div class="paragraph">
<p>Alternatively, use the  <a href="/gdk/get-started/using-gdk-cli/">GDK CLI</a> as follows:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">gdk create-app com.example.consumer.analytics \
 --clouds=aws \
 --services=streaming \
 --features=graalvm,serialization-jackson,awaitility \
 --build=gradle \
 --jdk=17  \
 --lang=java</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">gdk create-app com.example.consumer.analytics \
 --clouds=aws \
 --services=streaming \
 --features=graalvm,serialization-jackson,awaitility \
 --build=maven \
 --jdk=17  \
 --lang=java</code><button>Copy</button></pre>
    </div>
</div>
<div class="paragraph">
<p>Open the <em>micronaut-cli.yml</em> file, you can see what features are packaged with the application:</p>
</div>
<pre><code class="language-bash hljs" data-highlighted="yes">features: [app-name, awaitility, aws-v2-sdk, gdk-aws-cloud-app, gdk-aws-streaming, gdk-bom, gdk-license, graalvm, http-client, java, java-application, junit, kafka, logback, maven, maven-enforcer-plugin, micronaut-http-validation, netty-server, properties, readme, serialization-jackson, shade, static-resources, test-resources]</code><button>Copy</button></pre>
<div class="sect2">
<h3 id="domain-classes">2.1. Domain Classes</h3>
<div class="paragraph">
<p>The GDK Launcher created a <code>Book</code> domain class in a file named <em>lib/src/main/java/com/example/consumer/Book.java</em>, as shown below. (This <code>Book</code> POJO is the same as the one in the <em>Books</em> microservice. In a real application this would be in a shared library but to keep things simple, just duplicate it.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.consumer;

import io.micronaut.core.annotation.Creator;
import io.micronaut.serde.annotation.Serdeable;

import java.util.Objects;

@Serdeable
public class Book {

    private final String isbn;
    private final String name;

    @Creator
    public Book(String isbn, String name) {
        this.isbn = isbn;
        this.name = name;
    }

    public String getIsbn() {
        return isbn;
    }

    public String getName() {
        return name;
    }

    @Override
    public String toString() {
        return "Book{" +
                "isbn='" + isbn + '\'' +
                ", name='" + name + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Book other = (Book) o;
        return Objects.equals(isbn, other.isbn) &amp;&amp;
                Objects.equals(name, other.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(isbn, name);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The GDK Launcher also created a <code>BookAnalytics</code> domain class in a file named <em>lib/src/main/java/com/example/consumer/BookAnalytics.java</em>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.consumer;

import io.micronaut.core.annotation.Creator;
import io.micronaut.serde.annotation.Serdeable;

@Serdeable
public class BookAnalytics {

    private final String bookIsbn;
    private final long count;

    @Creator
    public BookAnalytics(String bookIsbn, long count) {
        this.bookIsbn = bookIsbn;
        this.count = count;
    }

    public String getBookIsbn() {
        return bookIsbn;
    }

    public long getCount() {
        return count;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="analyticsservice">2.2. AnalyticsService</h3>
<div class="paragraph">
<p>To keep this guide simple there is no database persistence: the <em>Analytics</em> microservice keeps book analytics in memory. The GDK Launcher created a class named <code>AnalyticsService</code> in <em>lib/src/main/java/com/example/consumer/AnalyticsService.java</em> with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.consumer;

import jakarta.inject.Singleton;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

@Singleton
public class AnalyticsService {

    private final Map&lt;Book, Long&gt; bookAnalytics = new ConcurrentHashMap&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>

    public void updateBookAnalytics(Book book) { <i class="conum" data-value="2"></i><b>(2)</b>
        bookAnalytics.compute(book, (k, v) -&gt; {
            return v == null ? 1L : v + 1;
        });
    }

    public List&lt;BookAnalytics&gt; listAnalytics() { <i class="conum" data-value="3"></i><b>(3)</b>
        return bookAnalytics
                .entrySet()
                .stream()
                .map(e -&gt; new BookAnalytics(e.getKey().getIsbn(), e.getValue()))
                .collect(Collectors.toList());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> Keep the book analytics in memory.</p>
</div>
<div class="paragraph">
<p><strong>2</strong> Initialize and update the analytics for the book passed as parameter.</p>
</div>
<div class="paragraph">
<p><strong>3</strong> Return all the analytics.</p>
</div>
</div>
<div class="sect2">
<h3 id="analyticsservicetest">2.3. AnalyticsServiceTest</h3>
<div class="paragraph">
<p>The GDK Launcher created a test for the <code>AnalyticsService</code> class, in a file named <em>aws/src/test/java/com/example/consumer/AnalyticsServiceTest.java</em>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.consumer;

import static org.junit.jupiter.api.Assertions.assertEquals;

import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import jakarta.inject.Inject;
import java.util.List;

@MicronautTest
class AnalyticsServiceTest {

    @Inject
    AnalyticsService analyticsService;

    @Test
    void testUpdateBookAnalyticsAndGetAnalytics() {
        Book b1 = new Book("1491950358", "Building Microservices");
        Book b2 = new Book("1680502395", "Release It!");

        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b2);

        List&lt;BookAnalytics&gt; analytics = analyticsService.listAnalytics();
        assertEquals(2, analytics.size());

        assertEquals(3, findBookAnalytics(b1, analytics).getCount());
        assertEquals(1, findBookAnalytics(b2, analytics).getCount());
    }

    private BookAnalytics findBookAnalytics(Book b, List&lt;BookAnalytics&gt; analytics) {
        return analytics
                .stream()
                .filter(bookAnalytics -&gt; bookAnalytics.getBookIsbn().equals(b.getIsbn()))
                .findFirst()
                .orElseThrow(() -&gt; new RuntimeException("Book not found"));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="analyticscontroller">2.4. AnalyticsController</h3>
<div class="paragraph">
<p>The GDK Launcher created a Controller to create an endpoint for the <em>Analytics</em> microservice in a file named <em>lib/src/main/java/com/example/consumer/AnalyticsController.java</em>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.consumer;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;

import java.util.List;

@Controller("/analytics") <i class="conum" data-value="1"></i><b>(1)</b>
class AnalyticsController {

    private final AnalyticsService analyticsService;

    AnalyticsController(AnalyticsService analyticsService) {
        this.analyticsService = analyticsService;
    }

    @Get <i class="conum" data-value="2"></i><b>(2)</b>
    List&lt;BookAnalytics&gt; listAnalytics() {
        return analyticsService.listAnalytics();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html"><code>@Controller</code></a> annotation defines the class as a controller mapped to the root URI <code>/analytics</code>.</p>
</div>
<div class="paragraph">
<p><strong>2</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>listAnalytics</code> method to an HTTP GET request on <code>/analytics</code>.</p>
</div>
<div class="paragraph">
<p>The application doesn&#8217;t expose the method <code>updateBookAnalytics</code> created in <code>AnalyticsService</code>. This method will be invoked when reading messages from Kafka.</p>
</div>
</div>
<div class="sect2">
<h3 id="analyticslistener">2.5. AnalyticsListener</h3>
<div class="paragraph">
<p>The GDK Launcher created a class to act as a consumer of the messages sent to the streaming service by the <em>Books</em> microservice. The Micronaut framework implements logic to invoke the consumer at compile time. The <code>AnalyticsListener</code> class is in a file named <em>lib/src/main/java/com/example/consumer/AnalyticsListener.java</em>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example.consumer;

import io.micronaut.configuration.kafka.annotation.KafkaListener;
import io.micronaut.configuration.kafka.annotation.Topic;
import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;

@Requires(notEnv = Environment.TEST) <i class="conum" data-value="1"></i><b>(1)</b>
@KafkaListener <i class="conum" data-value="2"></i><b>(2)</b>
class AnalyticsListener {

    private final AnalyticsService analyticsService; <i class="conum" data-value="3"></i><b>(3)</b>

    AnalyticsListener(AnalyticsService analyticsService) { <i class="conum" data-value="3"></i><b>(3)</b>
        this.analyticsService = analyticsService;
    }

    @Topic("analytics") <i class="conum" data-value="4"></i><b>(4)</b>
    void updateAnalytics(Book book) {
        analyticsService.updateBookAnalytics(book); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>1</strong> Do not load this bean in the <code>test</code> environment: you can run tests without access to a streaming service.</p>
</div>
<div class="paragraph">
<p><strong>2</strong> Annotate the class with <code>@KafkaListener</code> to indicate that this bean consumes messages from Kafka.</p>
</div>
<div class="paragraph">
<p><strong>3</strong> Constructor injection for <code>AnalyticsService</code>.</p>
</div>
<div class="paragraph">
<p><strong>4</strong> Annotate the method with <code>@Topic</code> and specify the topic name.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: This must match the name of the topic that you will create later.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>5</strong> Call <code>AnalyticsService</code> to update the analytics for the book.</p>
</div>
</div>
<div class="sect2">
<h3 id="test-the-microservice-2">2.6. Test the Microservice</h3>
<div class="paragraph">
<p>Use the following command to test the microservice</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">./gradlew :aws:test</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
./mvnw package -pl aws -DskipTests
./mvnw test</code><button>Copy</button></pre>
    </div>
</div>
</div>
<div class="sect2">
<h3 id="change-the-port-for-the-analytics-microservice">2.7. Change the port for the <em>Analytics</em> Microservice</h3>
<div class="paragraph">
<p>The <em>Books</em> and <em>Analytics</em> microservices are both run on your local machine, so they must run on different ports. Change the port that <em>Analytics</em> runs on by editing the <em>analytics/aws/src/main/resources/application.properties</em> file so that it has the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.server.port=8081
kafka.enabled=true</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-the-microservices">3. Run the Microservices</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="run-the-books-microservice">3.1. Run the <em>books</em> Microservice</h3>
<div class="paragraph">
<p>Run the <em>books</em> microservice as follows:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">MICRONAUT_ENVIRONMENTS=ec2  ./gradlew :aws:run</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
MICRONAUT_ENVIRONMENTS=ec2 ./mvnw mn:run -pl aws</code><button>Copy</button></pre>
    </div>
</div>
<div class="paragraph">
<p>Or if you use Windows:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">cmd /C "set MICRONAUT_ENVIRONMENTS=ec2 &amp;&amp; gradlew :aws:run"</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
cmd /C "set MICRONAUT_ENVIRONMENTS=ec2 &amp;&amp; mvnw -pl {oci} mn:run"</code><button>Copy</button></pre>
    </div>
</div>
</div>
<div class="sect2">
<h3 id="run-the-analytics-microservice">3.2. Run the <em>analytics</em> Microservice</h3>
<div class="paragraph">
<p>Run the <em>analytics</em> microservice as follows:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">MICRONAUT_ENVIRONMENTS=ec2  ./gradlew :aws:run</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
MICRONAUT_ENVIRONMENTS=ec2 ./mvnw mn:run -pl aws</code><button>Copy</button></pre>
    </div>
</div>
<div class="paragraph">
<p>Or if you use Windows:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">cmd /C "set MICRONAUT_ENVIRONMENTS=ec2 &amp;&amp; gradlew :aws:run"</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
cmd /C "set MICRONAUT_ENVIRONMENTS=ec2 &amp;&amp; mvnw -pl {oci} mn:run"</code><button>Copy</button></pre>
    </div>
</div>
</div>
<div class="sect2">
<h3 id="test-the-microservices">3.3. Test the Microservices</h3>
<div class="paragraph">
<p>Use <code>curl</code> to test the microservices, as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieve the list of books:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/books</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[{"isbn":"1491950358","name":"Building Microservices"},{"isbn":"1680502395","name":"Release It!"},{"isbn":"0321601912","name":"Continuous Delivery"}]</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the details of a specified book:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/books/1491950358</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"isbn":"1491950358","name":"Building Microservices"}</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the analytics:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8081/analytics</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[{"bookIsbn":"1491950358","count":1}]</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Update the <code>curl</code> command to the <em>Books</em> microservice to retrieve other books and repeat the invocations, then re-run the <code>curl</code> command to the <em>Analytics</em> microservice to see that the counts increase.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="set-up-aws-resources">4. Set up AWS Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start with creating an administrator account, then set up the networking, the Kafka cluster, and configure the AWS EC2 instance.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: In the instructions that follow, Windows users should replace the <code>export</code> keyword with <code>set</code>.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="create-an-administrator-account">4.1. Create an Administrator Account</h3>
<div class="paragraph">
<p>Instead of using your AWS root account, use an administrator account. If you do not have one already, see <a href="/gdk/get-started/setting-up-cloud-accounts/">Setting up Your Cloud Accounts</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-a-virtual-private-cloud-an-internet-gateway-and-a-route-table">4.2. Create a Virtual Private Cloud, an Internet Gateway, and a Route Table</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a virtual private cloud using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-vpc --cidr-block 10.0.0.0/16</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>Vpc.VpcId</code> property and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export VPC_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create an internet gateway using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-internet-gateway</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>InternetGateway.InternetGatewayId</code> property and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export IG_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Configure route tables using the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 attach-internet-gateway --internet-gateway-id $IG_ID --vpc-id $VPC_ID
aws ec2 modify-vpc-attribute --enable-dns-hostnames --vpc-id $VPC_ID
aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$VPC_ID"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>RouteTables[].RouteTableId</code> property and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export RT_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, create the route table using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-route \
    --route-table-id $RT_ID \
    --destination-cidr-block 0.0.0.0/0 \
    --gateway-id $IG_ID</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="create-subnets">4.3. Create Subnets</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Export the values of the AWS availability zones using the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export AZ_0=$(aws ec2 describe-availability-zones \
    --filters "Name=state,Values=available" \
    --query "AvailabilityZones[0].ZoneName" \
    --output text)
export AZ_1=$(aws ec2 describe-availability-zones \
    --filters "Name=state,Values=available" \
    --query "AvailabilityZones[1].ZoneName" \
    --output text)
export AZ_2=$(aws ec2 describe-availability-zones \
    --filters "Name=state,Values=available" \
    --query "AvailabilityZones[2].ZoneName" \
    --output text)</code></pre>
</div>
</div>
</li>
<li>
<p>Create three subnets using the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-subnet \
    --vpc-id $VPC_ID \
    --cidr-block 10.0.0.0/24 \
    --availability-zone $AZ_0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>Subnet.SubnetId</code> property and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export SN0_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-subnet \
    --vpc-id $VPC_ID \
    --cidr-block 10.0.1.0/24 \
    --availability-zone $AZ_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>Subnet.SubnetId</code> property and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export SN1_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-subnet \
    --vpc-id $VPC_ID \
    --cidr-block 10.0.2.0/24 \
    --availability-zone $AZ_2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>Subnet.SubnetId</code> property and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export SN2_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configure-a-msk-kafka-cluster">4.4. Configure a MSK Kafka Cluster</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new file named <em>aws_msk_cluster_broker_info.json</em> with the following contents. Replace the <code>ClientSubnets</code> values with the IDs of your subnets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "InstanceType": "kafka.m5.xlarge",
  "BrokerAZDistribution": "DEFAULT",
  "ClientSubnets": [
    "&lt;replace_with_the_subnet_id_0&gt;",
    "&lt;replace_with_the_subnet_id_1&gt;",
    "&lt;replace_with_the_subnet_id_2&gt;"
  ]
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new file named <em>aws_msk_cluster_auth_info.json</em> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "Sasl": {
    "Iam": {
      "Enabled": true
    }
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Kafka cluster using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export CLUSTER_ARN=$(aws kafka create-cluster \
    --cluster-name "AWSKafkaGDKGuide" \
    --broker-node-group-info file://aws_msk_cluster_broker_info.json \
    --client-authentication  file://aws_msk_cluster_auth_info.json \
    --kafka-version "3.5.1" \
    --number-of-broker-nodes 3 | jq -r '.ClusterArn')</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: You may have to wait up to 40 minutes before the cluster is in the ACTIVE state.</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Get and copy the <code>BootstrapBrokerStringSaslIam</code>, which you are going to use later.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KAFKA_BOOTSTRAP_SERVERS=$(aws kafka get-bootstrap-brokers --cluster-arn $CLUSTER_ARN | jq -r '.BootstrapBrokerStringSaslIam')</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: This command does not return results while cluster is in the CREATING state.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="configure-network">4.5. Configure Network</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Associate route table type for one subnet, to make it publicly available, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 associate-route-table --subnet-id $SN0_ID --route-table-id $RT_ID</code></pre>
</div>
</div>
</li>
<li>
<p>Map the public IP to the subnet using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 modify-subnet-attribute --subnet-id $SN0_ID --map-public-ip-on-launch</code></pre>
</div>
</div>
</li>
<li>
<p>Create a security group using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-security-group \
    --group-name gdk-guides-streaming-sg \
    --description "Security Group for the GDK Streaming guide" \
    --vpc-id $VPC_ID</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <code>GroupId</code> value and export it for later use, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export SG_ID=&lt;replace_with_the_copied_group_id_value&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create ingress rules to be able to connect to the instance via SSH, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 authorize-security-group-ingress \
    --group-id $SG_ID \
    --protocol tcp \
    --port 22 \
    --cidr 0.0.0.0/0</code></pre>
</div>
</div>
</li>
<li>
<p>To be able to issue requests to the <em>Books</em> and <em>Analytics</em> microservices, run the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 authorize-security-group-ingress \
    --group-id $SG_ID \
    --protocol tcp \
    --port 8080 \
    --cidr 0.0.0.0/0
aws ec2 authorize-security-group-ingress \
    --group-id $SG_ID \
    --protocol tcp \
    --port 8081 \
    --cidr 0.0.0.0/0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="launch-an-ec2-instance">4.6. Launch an EC2 Instance</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate and prepare an SSH key to be uploaded, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 create-key-pair \
    --key-name AWS-Keypair \
    --query "KeyMaterial" \
    --output text &gt; "AWS_Keypair.pem"</code></pre>
</div>
</div>
</li>
<li>
<p>Get the most current Amazon Machine Image (AMI) ID for your region:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 describe-images \
  --owners amazon \
  --filters "Name=name,Values=amzn*gp2" "Name=virtualization-type,Values=hvm" \
  --query "sort_by(Images, &amp;CreationDate)[-1].ImageId" \
  --output text</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: Copy the resulting AMI ID for later use.</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Launch an EC2 instance, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 run-instances \
    --image-id &lt;replace_with_the_copied_ami_image_id_value&gt; \
    --count 1 \
    --instance-type t2.large \
    --key-name AWS-Keypair \
    --subnet-id $SN0_ID \
    --block-device-mappings '[{"DeviceName":"/dev/xvda","Ebs":{"VolumeSize":8}}]'</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the value of the <code>Instances.InstanceId</code> property and export it for later use, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export INST_ID=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>To verify and get instance details, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 describe-instances --instance-id $INST_ID</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the value of the <code>Reservations.Instances.PublicIpAddress</code> property and export it for later use, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export PIPA=&lt;replace_with_the_copied_value&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>There is a default security group assigned to the EC2 instance.
However, you must add the custom security group that you created earlier.
Run the following command to retrieve the existing security groups:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export CURRENT_SG_IDS=$(aws ec2 describe-instances \
    --instance-ids $INST_ID \
    --query "Reservations[*].Instances[*].SecurityGroups[*].GroupId" \
    --output text)</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following commands to print the values of the existing security groups and the group you created earlier.
Create a new set by combining the values of each group.
(The set must contain distinct entries.)
Each entry must be enclosed by double quotes and separated by whitespace characters (for example, "sg-0f8eb8d4b8f66503f" "sg-0814ae2f87013d7f7"):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo $SG_ID
echo $CURRENT_SG_IDS</code></pre>
</div>
</div>
</li>
<li>
<p>Add the set of security groups to your EC2 instance, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 modify-instance-attribute \
    --instance-id $INST_ID \
    --groups "$SG_ID" "$CURRENT_SG_IDS"</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: You will use this EC2 instance to install the Kafka client library and to deploy <em>Books</em> and <em>Analytics</em> microservices.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="configure-role-and-policy">4.7. Configure Role and Policy</h3>
<div class="paragraph">
<p>Add the role and the policy for the EC2 instance to be able to interact with the Amazon MSK cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a file named <em>msk-gdk-guide-policy.json</em> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kafka-cluster:Connect",
        "kafka-cluster:AlterCluster",
        "kafka-cluster:DescribeCluster"
      ],
      "Resource": [
        "arn:aws:kafka:&lt;region&gt;:&lt;Account-ID&gt;:cluster/AWSKafkaGDKGuide/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "kafka-cluster:*Topic*",
        "kafka-cluster:WriteData",
        "kafka-cluster:ReadData"
      ],
      "Resource": [
        "arn:aws:kafka:&lt;region&gt;:&lt;Account-ID&gt;:topic/AWSKafkaGDKGuide/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "kafka-cluster:AlterGroup",
        "kafka-cluster:DescribeGroup"
      ],
      "Resource": [
        "arn:aws:kafka:&lt;region&gt;:&lt;Account-ID&gt;:group/AWSKafkaGDKGuide/*"
      ]
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>&lt;region&gt;</code> with the code of the Amazon Web Services Region where you created your cluster. Replace <code>&lt;Account-ID&gt;</code> with your account ID.</p>
</div>
</li>
<li>
<p>Create a new file named <em>msk-gdk-guide-role-trust-policy.json</em> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a role named "msk-gdk-guide-role" with the trust policy, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws iam create-role \
    --role-name msk-gdk-guide-role \
    --assume-role-policy-document file://msk-gdk-guide-role-trust-policy.json</code></pre>
</div>
</div>
</li>
<li>
<p>Attach an inline policy to the role using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws iam put-role-policy \
    --role-name msk-gdk-guide-role \
    --policy-name msk-gdk-guide-policy \
    --policy-document file://msk-gdk-guide-policy.json</code></pre>
</div>
</div>
</li>
<li>
<p>Create an IAM instance profile. The instance profile allows EC2 to pass the IAM role. Use the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws iam create-instance-profile \
    --instance-profile-name msk-gdk-guide-role-instance-profile
aws iam add-role-to-instance-profile \
    --role-name msk-gdk-guide-role \
    --instance-profile-name msk-gdk-guide-role-instance-profile</code></pre>
</div>
</div>
</li>
<li>
<p>Attach the IAM role to an existing EC2 instance, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 associate-iam-instance-profile \
    --instance-id $INST_ID \
    --iam-instance-profile Name=msk-gdk-guide-role-instance-profile</code></pre>
</div>
</div>
</li>
<li>
<p>You can verify that the IAM role is now attached to the instance using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws ec2 describe-iam-instance-profile-associations</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="install-and-configure-a-kafka-client">4.8. Install and Configure a Kafka Client</h3>
<div class="paragraph">
<p>Install and configure a Kafka client library on the EC2 instance.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: Apache Kafka version numbers used in this guide are examples only. When you need to connect to your Amazon MSK cluster using the Apache Kafka client, to create or change a topic configuration for example, ensure that the Apache Kafka client version you’re using matches your Amazon MSK cluster version. Be aware that using an Apache Kafka client version that is not the same as your MSK cluster version may lead to Apache Kafka data corruption, loss, and down time.</p>
</div>
</blockquote>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use SSH to connect the client EC2 instance, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh -i /path/AWS_Keypair.pem ec2-user@$PIPA</code></pre>
</div>
</div>
</li>
<li>
<p>Once connected, install GraalVM for Java 17. See <a href="https://www.graalvm.org/downloads/">Download Oracle GraalVM</a>.</p>
</li>
<li>
<p>Export the MSK version, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export MSK_VERSION=3.5.1</code></pre>
</div>
</div>
</li>
<li>
<p>Run the following command to download an Apache Kafka client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget https://archive.apache.org/dist/kafka/$MSK_VERSION/kafka_2.12-$MSK_VERSION.tgz</code></pre>
</div>
</div>
</li>
<li>
<p>Run the following command in the home directory where you downloaded the file in the previous step:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tar -xzf kafka_2.12-$MSK_VERSION.tgz</code></pre>
</div>
</div>
</li>
<li>
<p>Go to the Kafka client directory, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd kafka_2.12-$MSK_VERSION/bin</code></pre>
</div>
</div>
</li>
<li>
<p>Enable the IAM SASL mechanism to be able to connect to MSK from the client EC2 instance by creating a file named <em>client.properties</em> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler</code></pre>
</div>
</div>
</li>
<li>
<p>Go to the home directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ~</code></pre>
</div>
</div>
</li>
<li>
<p>Download the <code>aws-msk-iam-auth</code> library:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.9/aws-msk-iam-auth-1.1.9-all.jar</code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>aws-msk-iam-auth</code> library to the Kafka client classpath:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cp aws-msk-iam-auth-1.1.9-all.jar kafka_2.12-$MSK_VERSION/libs</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="create-a-kafka-topic">4.9. Create a Kafka Topic</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Export the bootstrap string which you saved earlier when you created the MSK cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KAFKA_BOOTSTRAP_SERVERS=&lt;replace_with_your_bootstrap_string&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Go to the Kafka client <em>bin/</em> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd kafka_2.12-$MSK_VERSION/bin</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Kafka topic named "analytics":</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./kafka-topics.sh --bootstrap-server $KAFKA_BOOTSTRAP_SERVERS \
    --command-config client.properties \
    --create \
    --topic analytics \
    --partitions 1 \
    --replication-factor 3</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-microservices">5. Configure Microservices</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the file named <em>aws/src/main/resources/application-ec2.properties</em> for the <em>Books</em> microservice so that it matches the following contents. (The Micronaut framework applies this configuration file only for the <code>ec2</code> environment.)</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">kafka.sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler
kafka.sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
kafka.sasl.mechanism=AWS_MSK_IAM
kafka.security.protocol=SASL_SSL</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the file named <em>aws/src/main/resources/application-ec2.properties</em> for the <em>Analytics</em> microservice so that it matches the following contents. (The Micronaut framework applies this configuration file only for the <code>ec2</code> environment.)</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">kafka.sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler
kafka.sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
kafka.sasl.mechanism=AWS_MSK_IAM
kafka.security.protocol=SASL_SSL</code></pre>
</div>
</div>
</li>
<li>
<p>After you deploy your applications to the AWS EC2 instance, make sure that the following environment variable is exported; Micronaut will set the <code>kafka.bootstrap.servers</code> configuration property from its value:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KAFKA_BOOTSTRAP_SERVERS=&lt;use the bootstrap string which you saved earlier when MSK cluster was created and promoted to the ACTIVE state&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Add the runtime-only <code>aws-msk-iam-auth</code> dependency to be able to authenticate the <em>Books</em> and <em>Analytics</em> microservices with the AWS MSK cluster. This is the same library that you have already added for the Kafka command line client to be able to create topics.</p>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <p>build.gradle</p>
<pre><code class="language-bash hljs" data-highlighted="yes">implementation("software.amazon.msk:aws-msk-iam-auth:1.1.9")
</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <p>pom.xml</p>
<pre><code class="language-bash hljs" data-highlighted="yes"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>software.amazon.msk<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aws-msk-iam-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code><button>Copy</button></pre>
    </div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generate-a-native-executable-using-graalvm">6. Generate a Native Executable Using GraalVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The GDK supports compiling Java applications ahead-of-time into native executables using <a href="https://www.graalvm.org/">GraalVM Native Image</a>.
You can use the <em><a href="https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html">Gradle plugin for GraalVM Native Image building</a></em>/<em><a href="https://graalvm.github.io/native-build-tools/latest/maven-plugin.html">Maven plugin for GraalVM Native Image building</a></em>.
Packaged as a native executable, it significantly reduces application startup time and memory footprint.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Prerequisites</strong>: Make sure you have installed a GraalVM JDK. The easiest way to get started is with <a href="https://sdkman.io/jdks#graal">SDKMAN!</a>. For other installation options, visit the <a href="https://www.graalvm.org/downloads/">Downloads section</a>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>To generate a native executable, run the following command for each microservice:</p>
</div>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew :aws:nativeCompile</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native executable is created in the build/native/nativeCompile/ directory and can be run with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">MICRONAUT_ENVIRONMENTS=ec2 aws/build/native/nativeCompile/aws</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you use Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">gradlew :aws:nativeCompile</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native executable is created in the aws\build\native\nativeCompile\ directory and can be run with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cmd /C "set MICRONAUT_ENVIRONMENTS=ec2 &amp;&amp; aws\build\native\nativeCompile{cloud}"</code></pre>
</div>
</div>
</div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw install -pl lib -am
./mvnw package -pl aws -Dpackaging=native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native executable is created in the target/ directory and can be run with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">MICRONAUT_ENVIRONMENTS=ec2 aws/target/aws</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you use Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvnw install -pl lib -am
mvnw clean package -pl aws -Dpackaging=native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native executable is created in the aws\target\ directory and can be run with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cmd /C "set MICRONAUT_ENVIRONMENTS=ec2 &amp;&amp; aws\target{cloud}"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-the-books-microservice-to-aws-cloud">7. Deploy the <em>Books</em> Microservice to AWS Cloud</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that the private key you downloaded has the correct permissions, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chmod 400 /path/to/AWS_Keypair.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Create a JAR file containing all the microservice&#8217;s dependencies, as follows:</p>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">./gradlew :aws:shadowJar</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am; ./mvnw package -pl aws -DskipTests</code><button>Copy</button></pre>
    </div>
</div>
</li>
<li>
<p>Copy the JAR file to your EC2 instance, as follows:</p>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">scp -i /path/to/AWS_Keypair.pem aws/build/libs/aws-1.0-SNAPSHOT-all.jar ec2-user@$PIPA:/home/ec2-user/books_application.jar</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">scp -i /path/to/AWS_Keypair.pem aws/target/aws-1.0-SNAPSHOT.jar ec2-user@$PIPA:/home/ec2-user/books_application.jar</code><button>Copy</button></pre>
    </div>
</div>
</li>
<li>
<p>Connect to the EC2 instance:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh -i /path/to/AWS_Keypair.pem ec2-user@$PIPA</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure that the following environment variable is exported; Micronaut will set the <code>kafka.bootstrap.servers</code> configuration property from its value:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KAFKA_BOOTSTRAP_SERVERS=&lt;use the bootstrap string which you saved earlier when MSK cluster was created and promoted to the ACTIVE state&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Start the <em>Books</em> microservice, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">MICRONAUT_ENVIRONMENTS=ec2 java -jar books_application.jar</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the application is running by invoking the controller at http://[EC2_PUBLIC_IP]:8080/books using <code>curl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -i http://$PIPA:8080/books</code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the controller endpoint to trigger a message to be published to the Streaming service. You can test other ISBNs as well.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -i http://$PIPA:8080/books/1491950358</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-the-analytics-microservice-to-aws-cloud">8. Deploy the <em>Analytics</em> Microservice to AWS Cloud</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a JAR file containing all the microservice&#8217;s dependencies, as follows:</p>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">./gradlew :aws:shadowJar</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am; ./mvnw package -pl aws -DskipTests</code><button>Copy</button></pre>
    </div>
</div>
</li>
<li>
<p>Copy the JAR file to your EC2 instance, as follows:</p>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">scp -i /path/to/AWS_Keypair.pem aws/build/libs/aws-1.0-SNAPSHOT-all.jar ec2-user@$PIPA:/home/ec2-user/analytics_application.jar</code><button>Copy</button></pre>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">scp -i /path/to/AWS_Keypair.pem aws/target/aws-1.0-SNAPSHOT.jar ec2-user@$PIPA:/home/ec2-user/analytics_application.jar</code><button>Copy</button></pre>
    </div>
</div>
</li>
<li>
<p>Connect to the EC2 instance:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh -i /path/to/AWS_Keypair.pem ec2-user@$PIPA</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure that the following environment variable is exported; Micronaut will set the <code>kafka.bootstrap.servers</code> configuration property from its value:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KAFKA_BOOTSTRAP_SERVERS=&lt;use the bootstrap string which you saved earlier when MSK cluster was created and promoted to the ACTIVE state&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Start the <em>Analytics</em> microservice, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">MICRONAUT_ENVIRONMENTS=ec2 java -jar analytics_application.jar</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the application is running by invoking the controller at http://[EC2_PUBLIC_IP]:8081/analytics using <code>curl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -i http://$PIPA:8081/analytics</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-native-executables-to-aws-cloud">9. Deploy Native Executables to AWS Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you build a native executable locally, it will only run on your OS, and is not suitable for deployment to AWS Cloud.
To create a deployable native executable, use a different packaging command that builds the executable inside a container, which you will extract from the container to deploy to the cloud.</p>
</div>
<div class="sect2">
<h3 id="configure-native-image">9.1. Configure Native Image</h3>
<div class="paragraph">
<p>The <code>aws-msk-iam-auth</code> authentication library relies on the Java reflection mechanism. GraalVM Native Image requires you to manually configure the library elements that are reflectively accessed at runtime. Create two configuration files for each microservice as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Books</em>:</p>
<div class="ulist">
<ul>
<li>
<p><em>aws/src/main/resources/META-INF/native-image/com.example.publisher/resource-config.json</em></p>
</li>
<li>
<p><em>aws/src/main/resources/META-INF/native-image/com.example.publisher/reflect-config.json</em></p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Analytics</em>:</p>
<div class="ulist">
<ul>
<li>
<p><em>aws/src/main/resources/META-INF/native-image/com.example.consumer/resource-config.json</em></p>
</li>
<li>
<p><em>aws/src/main/resources/META-INF/native-image/com.example.consumer/reflect-config.json</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The contents of the files are provided below.</p>
</div>
<div class="paragraph">
<p><em>resource-config.json</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "resources":{
  "includes":[
    {
      "pattern":"\\QMETA-INF/micronaut/io.micronaut.context.ApplicationContextConfigurer\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/micronaut/io.micronaut.inject.BeanConfiguration\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/micronaut/io.micronaut.inject.BeanDefinitionReference\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/com.fasterxml.jackson.databind.Module\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/io.micronaut.context.env.PropertySourceLoader\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/io.micronaut.core.convert.TypeConverterRegistrar\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/io.micronaut.core.type.TypeInformationProvider\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/io.micronaut.http.HttpRequestFactory\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/io.micronaut.http.client.HttpClientFactory\\E"
    }, 
    {
      "pattern":"\\QMETA-INF/services/java.nio.file.spi.FileSystemProvider\\E"
    }, 
    {
      "pattern":"\\Qapplication-ec2.properties\\E"
    },
    {
      "pattern":"\\Qapplication.properties\\E"
    },
    {
      "pattern":"\\Qcom/amazonaws/internal/config/awssdk_config_default.json\\E"
    }, 
    {
      "pattern":"\\Qcom/amazonaws/sdk/versionInfo.properties\\E"
    }, 
    {
      "pattern":"\\Qkafka/kafka-version.properties\\E"
    }, 
    {
      "pattern":"\\Qlogback.xml\\E"
    }, 
    {
      "pattern":"\\Qmicronaut-version.properties\\E"
    }, 
    {
      "pattern":"\\Qorg/slf4j/impl/StaticLoggerBinder.class\\E"
    }, 
    {
      "pattern":"\\Qtest-resources.properties\\E"
    },
    {
      "pattern":"\\Qcom/amazonaws/partitions/endpoints.json\\E"
    },
    {
      "pattern":"org/joda/time/tz/data/.*"
    }
  ]},
  "bundles":[{
      "name":"sun.security.util.Resources",
      "classNames":["sun.security.util.Resources"]
    }]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>reflect-config.json</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name":"software.amazon.msk.auth.iam.IAMClientCallbackHandler",
    "methods":[{"name":"&lt;init&gt;","parameterTypes":[] }]
  },
  {
    "name":"org.apache.commons.logging.impl.Jdk14Logger",
    "methods":[{"name":"&lt;init&gt;","parameterTypes":["java.lang.String"] }]
  },
  {
    "name":"org.apache.commons.logging.impl.Log4JLogger"
  },
  {
    "name":"org.apache.commons.logging.impl.LogFactoryImpl",
    "methods":[{"name":"&lt;init&gt;","parameterTypes":[] }]
  },
  {
    "name":"com.amazonaws.internal.config.InternalConfigJsonHelper",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setDefaultSigner","parameterTypes":["com.amazonaws.internal.config.SignerConfigJsonHelper"] },
      {"name":"setHostRegexToRegionMappings","parameterTypes":["com.amazonaws.internal.config.HostRegexToRegionMappingJsonHelper[]"] },
      {"name":"setHttpClients","parameterTypes":["com.amazonaws.internal.config.JsonIndex[]"] },
      {"name":"setRegionSigners","parameterTypes":["com.amazonaws.internal.config.JsonIndex[]"] },
      {"name":"setServiceRegionSigners","parameterTypes":["com.amazonaws.internal.config.JsonIndex[]"] },
      {"name":"setServiceSigners","parameterTypes":["com.amazonaws.internal.config.JsonIndex[]"] },
      {"name":"setUserAgentTemplate","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.internal.config.SignerConfigJsonHelper",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setSignerType","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.internal.config.JsonIndex",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setConfig","parameterTypes":["com.amazonaws.internal.config.Builder"] },
      {"name":"setKey","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.internal.config.HttpClientConfigJsonHelper",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setRegionMetadataServiceName","parameterTypes":["java.lang.String"] },
      {"name":"setServiceName","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.internal.config.HostRegexToRegionMappingJsonHelper",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setHostNameRegex","parameterTypes":["java.lang.String"] },
      {"name":"setRegionName","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"software.amazon.msk.auth.iam.internals.AuthenticationResponse",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[{"name":"&lt;init&gt;","parameterTypes":["java.lang.String","java.lang.String"] }]
  },
  {
    "name":"software.amazon.msk.auth.iam.IAMLoginModule",
    "methods":[{"name":"&lt;init&gt;","parameterTypes":[] }]
  },
  {
    "name":"software.amazon.msk.auth.iam.internals.IAMSaslClient$ClassLoaderAwareIAMSaslClientFactory",
    "methods":[{"name":"&lt;init&gt;","parameterTypes":[] }]
  },
  {
    "name":"software.amazon.msk.auth.iam.internals.IAMSaslClient$IAMSaslClientFactory",
    "methods":[{"name":"&lt;init&gt;","parameterTypes":[] }]
  },
  {
    "name":"com.amazonaws.partitions.model.CredentialScope",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setRegion","parameterTypes":["java.lang.String"] },
      {"name":"setService","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.partitions.model.Endpoint",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":[] },
      {"name":"setCredentialScope","parameterTypes":["com.amazonaws.partitions.model.CredentialScope"] },
      {"name":"setHostName","parameterTypes":["java.lang.String"] },
      {"name":"setProtocols","parameterTypes":["java.util.Set"] },
      {"name":"setSignatureVersions","parameterTypes":["java.util.Set"] },
      {"name":"setSslCommonName","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.partitions.model.Partition",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":["java.lang.String","java.util.Map","java.util.Map"] },
      {"name":"setDefaults","parameterTypes":["com.amazonaws.partitions.model.Endpoint"] },
      {"name":"setDnsSuffix","parameterTypes":["java.lang.String"] },
      {"name":"setPartitionName","parameterTypes":["java.lang.String"] },
      {"name":"setRegionRegex","parameterTypes":["java.lang.String"] }
    ]
  },
  {
    "name":"com.amazonaws.partitions.model.Partitions",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[{"name":"&lt;init&gt;","parameterTypes":["java.lang.String","java.util.List"] }]
  },
  {
    "name":"com.amazonaws.partitions.model.Region",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[{"name":"&lt;init&gt;","parameterTypes":["java.lang.String"] }]
  },
  {
    "name":"com.amazonaws.partitions.model.Service",
    "allDeclaredFields":true,
    "queryAllDeclaredMethods":true,
    "queryAllDeclaredConstructors":true,
    "methods":[
      {"name":"&lt;init&gt;","parameterTypes":["java.util.Map"] },
      {"name":"setDefaults","parameterTypes":["com.amazonaws.partitions.model.Endpoint"] },
      {"name":"setPartitionEndpoint","parameterTypes":["java.lang.String"] },
      {"name":"setRegionalized","parameterTypes":["boolean"] }
    ]
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-native-executables-on-ec2-instance">9.2. Run Native Executables on EC2 Instance</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the <a href="#download">example ZIP file</a> and copy it to the EC2 instance:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">scp -i /path/to/AWS_Keypair.pem /path/to/downloaded/streaming_sample.zip ec2-user@$PIPA:/home/ec2-user/streaming_sample.zip</code></pre>
</div>
</div>
</li>
<li>
<p>Once copied, connect to the EC2 instance (if it has disconnected by now):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh -i /path/to/AWS_Keypair.pem ec2-user@$PIPA</code></pre>
</div>
</div>
</li>
<li>
<p>Unpack the compressed file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo yum install unzip
unzip streaming_sample.zip</code></pre>
</div>
</div>
</li>
<li>
<p>Install the packages that GraalVM needs to work properly on EC2:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo yum -y install gcc
sudo yum -y install zlib*</code></pre>
</div>
</div>
</li>
<li>
<p>You must apply the settings from sections <strong>5</strong> (Configure Microservices) and <strong>8.1</strong> (Configure Native Image).</p>
</li>
<li>
<p>To generate a native executable, run the following command for each microservice:</p>
<div class="gradle-maven-tabs ui-tabs ui-corner-all ui-widget ui-widget-content">
    <ul role="tablist" class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header">
        <li class="tabs-gradle ui-tabs-tab ui-corner-top ui-state-default ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="gradle" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a name="gradle" href="#gradle" tabindex="-1" class="ui-tabs-anchor" id="ui-id-1">Gradle</a></li>
        <li class="tabs-maven ui-tabs-tab ui-corner-top ui-state-default" role="tab" tabindex="-1" aria-controls="maven" aria-labelledby="ui-id-2" aria-selected="false" aria-expanded="false"><a name="maven" href="#maven" tabindex="-1" class="ui-tabs-anchor" id="ui-id-2">Maven</a></li>
    </ul>
    <div id="gradle" aria-labelledby="ui-id-1" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="false">
        <pre><code class="language-bash hljs" data-highlighted="yes">./gradlew :aws:nativeCompile</code><button>Copy</button></pre><p>The native executable aws-streaming-demo is created in the build/native/nativeCompile/ directory</p>
    </div>
    <div id="maven" aria-labelledby="ui-id-2" role="tabpanel" class="ui-tabs-panel ui-corner-bottom ui-widget-content" aria-hidden="true" style="display: none;">
        <pre><code class="language-bash hljs" data-highlighted="yes">./mvnw install -pl lib -am
./mvnw clean package -pl aws -Dpackaging=native-image</code><button>Copy</button></pre><p>The native executable aws-streaming-demo is created in the target/ directory</p>
    </div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Start the native executables for the two microservices and run the same <code>curl</code> requests as before to check that everything works as expected.</p>
</div>
<div class="paragraph">
<p>You can see that the microservices behave identically as if you run them from JAR files, but with reduced startup time and smaller memory footprint.</p>
</div>
<h3 id="summary" class="discrete">Summary</h3>
<div class="paragraph">
<p>In this guide you created a streaming application with the Micronaut framework, Kafka, and Amazon Managed Streaming for Apache Kafka (MSK). The communication between two microservices acting as a producer and consumer ran asynchronously. Then you packaged these microservices into native executables with GraalVM Native Image for their faster startup and reduced memory footprint, and deployed to AWS Cloud.</p>
</div>
<h3 id="related-documentation" class="discrete">Related Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://aws.amazon.com/msk/">Amazon Managed Streaming for Apache Kafka (MSK)</a></p>
</li>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Kafka support in Micronaut</a></p>
</li>
<li>
<p><a href="https://developer.oracle.com/languages/graalvm/gdk.html">Graal Development Kit for Micronaut</a></p>
</li>
<li>
<p><a href="https://luna.oracle.com/lab/47dafec8-4095-4fba-8313-dad43a64dee4">GraalVM Native Image Quick Start</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div>
                        <div role="button" class="menu-btn menu-btn--sidebar js-show-sidebar" title="sweet hamburger">
                            <div class="hamburger">
                                <div class="inner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </article>



        </div>

    </main>


    <footer class="footer footer__mobile">

        <div class="container-fluid container-fluid--custom-sm">
            <div class="row">
                <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="row footer-content">
                        <div class="col-md-3 col-sm-4">
                            <h6 class="title-footer" onclick="fadeInAndOut(this)">Learn</h6>
                            <div class="grow">
                                <ul class="footer-list">
                                    <li class="footer-list__item"><a href="/gdk/get-started/">Get Started</a></li>
                                    <li class="footer-list__item"><a href="/gdk/guides/">Guides</a></li>
                                    <li class="footer-list__item"><a href="/gdk/hands-on-labs/">Labs</a></li>
                                    <li class="footer-list__github">
                                        <img class="footer__icon" src="https://graal.cloud/gdk/resources/img/footer/logo-github.svg" alt="Github icon">
                                        <a href="https://github.com/oracle/graal-dev-kit" target="blank">Github</a>
                                    </li>
                                    <li class="footer-list__github">
                                        <img class="footer__icon" src="https://graal.cloud/gdk/resources/img/footer/slack-icon.svg" alt="Github icon">
                                        <a href="https://bit.ly/odevrel_slack" target="blank">#graal-dev-kit-for-micronaut</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-4">
                            <h6 class="title-footer" onclick="fadeInAndOut(this)">About</h6>
                            <div class="grow">
                                <ul class="footer-list">
                                    <li class="footer-list__item"><a href="/gdk/about/#gdk-support" target="blank">Commercial Support</a></li>
                                    <li class="footer-list__item"><a href="https://www.graalvm.org/" target="blank">GraalVM Native Image</a></li>
                                    <li class="footer-list__item"><a href="https://micronaut.io/" target="_blank">Micronaut<sup>®</sup> Framework</a></li>
                                    <li class="footer-list__item"><a href="https://www.oracle.com/cloud/multicloud/what-is-multicloud/" target="_blank">Multicloud</a></li>
                                    <li class="footer-list__item"><a href="https://www.oracle.com/cloud/" target="blank">Oracle Cloud Infrastructure</a></li>
                                    <li class="footer-list__item"><a href="https://marketplace.visualstudio.com/items?itemName=oracle-labs-graalvm.graal-cloud-native-pack" target="blank">VS Code Tools</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-12 aligning_1024">
                            <div class="card--footer card--hovered box">
                                <div>
                                    <div class="rubber-footer footer__oci-section">
                                        <p class="title-footer quickstart">Build, test, and deploy applications on Oracle Cloud Infrastructure for free</p>
                                        <a href="https://www.oracle.com/cloud/free/" target="_blank" class="btn btn-primary">Try Oracle Cloud Infrastructure Free Tier</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="row">
                            <div class="col-sm-12">
                                <p class="copyright">
                                    Copyright © 2023, 2025, Oracle and/or its affiliates.
                                    All rights reserved.
                                    Oracle and Java are registered trademarks of Oracle and/or its affiliates.<br>
                                    Micronaut<sup>®</sup> is a registered trademark of Object Computing, Inc.
                                    Use is for referential purposes and does not imply any endorsement or affiliation with any third-party product.
                                    Unauthorized use is strictly prohibited. Other names may be trademarks of their respective owners.
                                </p>
                                <div id="teconsent"></div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </footer>

    <script>
        function fadeInAndOut(thz) {
            var elmt = thz.nextElementSibling;//Get the element that is below the button that
            //was just clicked
            if (elmt.clientHeight) {
                elmt.style.height = 0;
            } else {
                var wrapper = elmt.querySelector('ul');
                elmt.style.height = wrapper.clientHeight + "px";
            }
            /*
                elmt.classList.toggle("acordianPanelHidden");//Toggle the class which changes
                //attributes which triggers the transition CSS
                */
        }

        // Check TRUSTe Consent for Functional or Implied Approval
        // The if test verifies if the user has given the consent
        if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
            (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
                oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(2) != -1) ) {

            //The following is a sample of a Maxymiser Tag being written to the DOM
            //If the user did not give consent, then the tag is not included and not invoked in the Browser
            document.write('<script type="text/javascript" src="//service.maxymiser.net/cdn/oracle/js/mmcore.js"><\/script>');
        }

        // Check TRUSTe Consent for Advertising or Implied Approval
        // The if test verifies if the user has given the consent
        if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
            (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
                oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(3) != -1) ) {

            //The following is a sample of a BlueKai Core Tag being written to the DOM
            //If the user did not give consent, then the tag is not included and not invoked in the Browser
            document.write('<script type="text/javascript">' +
                'window.bk_async = function() { ' +
                'BKTAG.doTag(62581, 1); }; ' +
                '(function() { ' +
                'var scripts = document.getElementsByTagName(\'script\')[0]; ' +
                'var s = document.createElement(\'script\'); ' +
                's.async = true; ' +
                's.src = "https://tags.bkrtx.com/js/bk-coretag.js"; ' +
                'scripts.parentNode.insertBefore(s, scripts); ' +
                '}()); ' +
                '<\/script>');
        }
    </script><script type="text/javascript" src="//service.maxymiser.net/cdn/oracle/js/mmcore.js"></script><script type="text/javascript">window.bk_async = function() { BKTAG.doTag(62581, 1); }; (function() { var scripts = document.getElementsByTagName('script')[0]; var s = document.createElement('script'); s.async = true; s.src = "https://tags.bkrtx.com/js/bk-coretag.js"; scripts.parentNode.insertBefore(s, scripts); }()); </script>

</div>
<div class="overlay"></div>

<!-- Start SiteCatalyst code -->
<script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script><script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_code_otn.js"></script><script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_code.js"></script>
<!-- End SiteCatalyst code -->

<script src="https://graal.cloud/gdk/resources/lib/slick-slider/slick.min.js"></script>
<script src='https://graal.cloud/gdk/resources/js/main.js'></script>
<script src="https://graal.cloud/gdk/resources/js/ui.js"></script>
<script src="https://graal.cloud/gdk/resources/js/filters.js"></script>
<script src="https://graal.cloud/gdk/resources/js/sidebar.js"></script>
<script src="https://graal.cloud/gdk/resources/js/labs.js"></script>
<!--<script>-->
<!--    hljs.initHighlightingOnLoad();-->
<!--</script>-->


<iframe name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=oracle.com" style="display: none;"></iframe></body></html>